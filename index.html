<!doctype html>
<html lang="de" data-theme="sky">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cruise at Sunset – API Demo</title>

    <!-- Bootstrap Grid/Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>

    <!-- Topbar -->
    <header class="container py-3 topbar">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h1 class="app-title m-0">
          <span class="logo-dot"></span>
          <span class="grad">Cruise at Sunset</span>
        </h1>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="chip muted" id="lastUpdateChip" aria-live="polite">bereit zum Abflug</span>

          <!-- NEW: Seatbelt badge shows when seatbelt is ON -->
          <span id="seatbeltBadge" class="chip warn tiny d-none">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Gurt an
          </span>

          <button id="themeToggle" class="btn runway small" type="button" aria-pressed="false" title="Theme wechseln">
            <i class="bi bi-brightness-high me-1"></i> Theme
          </button>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
        <button id="btnRefreshAll" class="btn runway"><i class="bi bi-arrow-repeat me-2"></i>Refresh All</button>

        <label class="switch chip tiny">
          <input id="autoRefreshToggle" type="checkbox" />
          <span><i class="bi bi-clock-history me-1"></i>Auto-Refresh 60 s</span>
        </label>

        <!-- NEW: Cabin lights + Seatbelt + Turbulence -->
        <label class="switch chip tiny">
          <input id="cabinLightsToggle" type="checkbox" />
          <span><i class="bi bi-lightbulb me-1"></i>Kabinenlicht</span>
        </label>

        <label class="switch chip tiny">
          <input id="seatbeltToggle" type="checkbox" />
          <span><i class="bi bi-seatbelt me-1"></i>Sicherheitsgurt</span>
        </label>

        <label class="switch chip tiny">
          <input id="turbulenceToggle" type="checkbox" />
          <span><i class="bi bi-wind me-1"></i>Turbulence</span>
        </label>
      </div>
    </header>

    <main class="container pb-5">
      <div class="grid">
        <!-- Katzenbild -->
        <section class="card window">
          <div class="card-header">
            <h2 class="panel-title">
              <span class="panel-icon"><i class="bi bi-heart"></i></span>
              Cabin Cam – Zufälliges Katzenbild
            </h2>
            <span class="altimeter"></span>
          </div>
          <p class="card-sub">Blick aus der Kabine: ein neuer Passagier auf vier Pfoten.</p>

          <div class="mb-3">
            <button id="btnCat" class="btn runway"><i class="bi bi-stars me-2"></i>Neue Katze</button>
          </div>

          <div id="catResult" class="window-porthole ratio ratio-16x9"></div>
        </section>

        <!-- Bitcoin -->
        <section class="card window">
          <div class="card-header">
            <h2 class="panel-title">
              <span class="panel-icon"><i class="bi bi-currency-bitcoin"></i></span>
              Tower Feed – Bitcoin-Preis
            </h2>
            <span class="altimeter"></span>
          </div>
          <p class="card-sub">Direkt aus dem Tower (CoinGecko). Anzeige im <span class="chip tiny">de-CH</span> Format.</p>

          <div class="mb-3 d-flex gap-2 align-items-center">
            <button id="btnBtc" class="btn runway"><i class="bi bi-coin me-2"></i>Laden</button>
            <span id="btcBadge" class="chip muted tiny" aria-live="polite">—</span>
          </div>

          <div id="btcResult" class="stats"><!-- Tiles per JS --></div>
        </section>

        <!-- Wetter -->
        <section class="card window">
          <div class="card-header">
            <h2 class="panel-title">
              <span class="panel-icon"><i class="bi bi-cloud-sun"></i></span>
              Flight Conditions – Wetter (Zürich)
            </h2>
            <span class="altimeter"></span>
          </div>
          <p class="card-sub">Golden Hour Check (Open-Meteo): Max/Min &amp; Niederschlag heute.</p>

          <div class="mb-3">
            <button id="btnWeather" class="btn runway"><i class="bi bi-cloud-drizzle me-2"></i>Laden</button>
          </div>

          <div id="weatherResult" class="stats"><!-- Tiles per JS --></div>
        </section>

        <!-- EV + Suche -->
        <section class="card window">
          <div class="card-header">
            <h2 class="panel-title">
              <span class="panel-icon"><i class="bi bi-ev-station"></i></span>
              Ground Ops – 5 Ladestationen
            </h2>
            <span class="altimeter"></span>
          </div>
          <p class="card-sub">PLZ eingeben oder Standard-Anflug Winterthur laden. Klick auf eine Station fokussiert die Karte.</p>

          <div class="d-flex flex-wrap gap-2 align-items-start mb-2">
            <label class="input">
              <span>PLZ</span>
              <input id="zipInput" placeholder="z. B. 8400" inputmode="numeric" />
            </label>
            <button id="btnChargingZip" class="btn runway"><i class="bi bi-search me-2"></i>Nach PLZ</button>
            <button id="btnCharging" class="btn runway ghost"><i class="bi bi-lightning-charge me-2"></i>Umkreis Winterthur</button>
            <span id="evCountChip" class="chip tiny muted" aria-live="polite">—</span>
          </div>

          <!-- NEW: Waypoints / Favoriten -->
          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <span class="chip tiny muted"><i class="bi bi-geo me-1"></i>Waypoints</span>
            <div id="zipChips" class="chip-row d-flex flex-wrap gap-2"></div>
            <button id="addZipFav" class="btn runway small"><i class="bi bi-plus-lg me-1"></i>Favorit</button>
          </div>

          <div id="chargingResult" class="result-window"></div>
        </section>

        <!-- Map -->
        <section class="card window map-card">
          <div class="card-header">
            <h2 class="panel-title">
              <span class="panel-icon"><i class="bi bi-geo-alt"></i></span>
              Window Seat – Karte
            </h2>
            <span class="altimeter"></span>
          </div>
          <p class="card-sub">Zentriert auf Auswahl – wie ein Blick aus dem Fenster beim Kurvenflug.</p>

          <div class="mb-3">
            <button id="btnMap" class="btn runway"><i class="bi bi-map me-2"></i>Karte anzeigen</button>
          </div>

          <div id="map" class="window-porthole map-viewport">
            <div class="map-vignette" aria-hidden="true"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- Toasts -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js"></script>

    <!-- Small helper JS for the new UI features (keine API-Änderungen) -->
    <script>
      (function () {
        const $html = document.documentElement;
        const seatbeltBadge = document.getElementById('seatbeltBadge');

        // Refresh All + Auto-Refresh (wie vorher)
        const btnCat = document.getElementById('btnCat');
        const btnBtc = document.getElementById('btnBtc');
        const btnWeather = document.getElementById('btnWeather');
        const btnCharging = document.getElementById('btnCharging');
        const btnChargingZip = document.getElementById('btnChargingZip');
        const zipInput = document.getElementById('zipInput');

        document.getElementById('btnRefreshAll').addEventListener('click', () => {
          btnCat?.click(); btnBtc?.click(); btnWeather?.click();
          const hasZip = (zipInput?.value || '').trim().length > 0;
          (hasZip ? btnChargingZip : btnCharging)?.click();
        });

        const autoT = document.getElementById('autoRefreshToggle');
        let timer = null;
        autoT.addEventListener('change', () => {
          if (autoT.checked) {
            document.getElementById('btnRefreshAll').click();
            timer = setInterval(() => document.getElementById('btnRefreshAll').click(), 60000);
          } else { clearInterval(timer); timer = null; }
        });

        // ===== NEW: Cabin lights toggle =====
        const lightsT = document.getElementById('cabinLightsToggle');
        if (localStorage.getItem('cabinLights') === 'on') {
          lightsT.checked = true; $html.classList.add('cabin-on');
        }
        lightsT.addEventListener('change', () => {
          $html.classList.toggle('cabin-on', lightsT.checked);
          localStorage.setItem('cabinLights', lightsT.checked ? 'on' : 'off');
        });

        // ===== NEW: Seatbelt toggle =====
        const seatT = document.getElementById('seatbeltToggle');
        if (localStorage.getItem('seatbelt') === 'on') {
          seatT.checked = true; $html.classList.add('seatbelt-on'); seatbeltBadge.classList.remove('d-none');
        }
        seatT.addEventListener('change', () => {
          const on = seatT.checked;
          $html.classList.toggle('seatbelt-on', on);
          seatbeltBadge.classList.toggle('d-none', !on);
          localStorage.setItem('seatbelt', on ? 'on' : 'off');
        });

        // ===== NEW: Turbulence Mode =====
        const turbT = document.getElementById('turbulenceToggle');
        if (localStorage.getItem('turbulence') === 'on') {
          turbT.checked = true; $html.classList.add('turbulence-on');
        }
        turbT.addEventListener('change', () => {
          $html.classList.toggle('turbulence-on', turbT.checked);
          localStorage.setItem('turbulence', turbT.checked ? 'on' : 'off');
        });

        // ===== NEW: Waypoints / ZIP favorites =====
        const addFavBtn = document.getElementById('addZipFav');
        const chipRow = document.getElementById('zipChips');
        const LS_KEY = 'favZips';

        function loadFavs() {
          try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
          catch { return []; }
        }
        function saveFavs(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
        function renderFavs(){
          const favs = loadFavs();
          chipRow.innerHTML = '';
          if (!favs.length) {
            chipRow.innerHTML = '<span class="chip tiny muted">Keine Favoriten</span>';
            return;
          }
          favs.forEach(zip => {
            const chip = document.createElement('span');
            chip.className = 'chip tiny chip-fav';
            chip.innerHTML = `<i class="bi bi-geo-alt me-1"></i>${zip}<button class="chip-x" aria-label="Favorit entfernen" title="Entfernen">&times;</button>`;
            chip.addEventListener('click', (e) => {
              if ((e.target).classList.contains('chip-x')) return; // remove handled below
              zipInput.value = String(zip);
              btnChargingZip.click();
            });
            chip.querySelector('.chip-x').addEventListener('click', (e) => {
              e.stopPropagation();
              const next = loadFavs().filter(z => String(z) !== String(zip));
              saveFavs(next); renderFavs();
            });
            chipRow.appendChild(chip);
          });
        }
        addFavBtn.addEventListener('click', () => {
          const z = (zipInput.value || '').trim();
          if (!/^\d{4,5}$/.test(z)) { alert('Bitte gültige PLZ eingeben.'); return; }
          const favs = loadFavs();
          if (!favs.includes(z)) { favs.push(z); saveFavs(favs); renderFavs(); }
        });
        renderFavs();
      })();
    </script>
  </body>
</html>
